name: Dev CI-CD
on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Please select your command'
        type: choice
        options:
          - SCHEMA_CHANGED
          - JUST_INDEX
          - MIGRATE_UP
          - MIGRATE_DOWN_UP
      build:
        description: 'Build new image'
        type: boolean
        default: false
env:
  REGION: eu-central-1
  PLATFORM: dev
  REPO_NAME: ${{ github.event.repository.name }}
  ECR_REPOSITORY: ${{ github.event.repository.name }}-dev

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{secrets.ACCOUNT_ID_DEV}}:role/platform-github-action-role-${{env.PLATFORM}}
          aws-region: ${{ env.REGION }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set ECR environment variables
        run: |
          echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=$PLATFORM-${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Check if image exists
        run: |
          if aws ecr describe-images --repository-name $ECR_REPOSITORY --image-ids imageTag=$IMAGE_TAG 2>/dev/null; then
            echo "IMAGE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "IMAGE_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: If skip build or image exists, set image tag to latest remote
        id: get-latest-image-tag
        if: inputs.build == false || env.IMAGE_EXISTS == 'true'
        run: |
          LATEST_TAG=$(aws ecr describe-images --repository-name $ECR_REPOSITORY --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' --output text)
          # override image tag with latest tag if it exists
          if [ -n "$LATEST_TAG" ]; then
            echo "IMAGE_TAG=$LATEST_TAG" >> $GITHUB_ENV
          fi

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        if: env.IMAGE_EXISTS == 'false' && inputs.build == true
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - uses: act10ns/slack@v1
        if: always() && inputs.build == true
        with:
          status: ${{ job.status }}
          channel: 'n-platform-deployments'
          config: .github/config/slack.yml
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}

    outputs:
      image_tag: ${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: always() && !cancelled()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{secrets.ACCOUNT_ID_DEV}}:role/platform-github-action-role-${{env.PLATFORM}}
          aws-region: ${{ env.REGION }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set ECR environment variables
        run: |
          echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV

      - name: Get Latest Image ARN
        id: get-image-arn
        run: |
          # Get full image URI
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Verifying image: $IMAGE_URI"

          # Verify image exists via ecr and image uri
          if ! aws ecr describe-images --repository-name $ECR_REPOSITORY --image-ids imageTag=$IMAGE_TAG 2>/dev/null; then
            echo "Image verification failed: $IMAGE_URI not found in repository $ECR_REPOSITORY"
            exit 1
          fi

          echo "Image verification successful"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Create Task Definition
        id: task-def
        run: |
          MIGRATE_SETUP='node -e "require('\''./generated/src/db/Migrations.bs.js'\'').setupDb()"'
          MIGRATE_UP='node -e "require('\''./generated/src/db/Migrations.bs.js'\'').runUpMigrations(true)"'
          MIGRATE_DOWN='node -e "require('\''./generated/src/db/Migrations.bs.js'\'').runDownMigrations(true)"'
          GRANT_PERMISSIONS='pnpm ts-node scripts/grant-aggregate-permissions.ts'
          RUN_INDEXER='TUI_OFF=true pnpm ts-node generated/src/Index.bs.js'

          case "${{ inputs.env }}" in
            "SCHEMA_CHANGED")
              CMD="$MIGRATE_SETUP && $GRANT_PERMISSIONS && $RUN_INDEXER"
              ;;
            "MIGRATE_UP")
              CMD="$MIGRATE_UP && $GRANT_PERMISSIONS && $RUN_INDEXER"
              ;;
            "MIGRATE_DOWN_UP")
              CMD="$MIGRATE_DOWN && $MIGRATE_UP && $GRANT_PERMISSIONS && $RUN_INDEXER"
              ;;
            "JUST_INDEX")
              CMD="$GRANT_PERMISSIONS && $RUN_INDEXER"
              ;;
            *)
              echo "Invalid command type" && exit 1
              ;;
          esac

          # Get current task definition and remove AWS-specific fields
          aws ecs describe-task-definition --task-definition indexer-dev --query 'taskDefinition' > task-definition-full.json

          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' task-definition-full.json > task-definition.json

          # Update the command and image in the indexer-dev container using IMAGE_URI and CMD
          jq --arg cmd "$CMD" --arg img $IMAGE_URI '(.containerDefinitions[] | select(.name == "indexer-dev") | .command) = ["sh", "-c", $cmd] | (.containerDefinitions[] | select(.name == "indexer-dev") | .image) = $img' task-definition.json > updated-task-definition.json

          # Update the task definition with the new file
          mv updated-task-definition.json task-definition.json

          # Store the task definition ARN
          echo "TASK_DEFINITION_ARN=$(aws ecs register-task-definition --cli-input-json file://task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)" >> $GITHUB_ENV

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{env.PLATFORM}}-services-cluster \
            --service ${{ env.REPO_NAME }}-${{env.PLATFORM}} \
            --task-definition ${{ env.TASK_DEFINITION_ARN }} \
            --force-new-deployment

      - name: Wait for service stability
        timeout-minutes: 5
        run: |
          aws ecs wait services-stable \
            --cluster ${{env.PLATFORM}}-services-cluster \
            --services ${{ env.REPO_NAME }}-${{env.PLATFORM}}

      - name: Slack Notification
        uses: act10ns/slack@v1
        with:
          status: ${{ job.status }}
          channel: 'n-platform-deployments'
          config: .github/config/slack.yml
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          steps: ${{ toJson(steps) }}
        if: always()
